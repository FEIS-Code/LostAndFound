<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Five Elements International School Lost & Found</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        /* Custom scrollbar for aesthetics */
        .report-container::-webkit-scrollbar {
            width: 8px;
        }
        .report-container::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 10px;
        }
        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-3xl font-extrabold tracking-tight mb-2 sm:mb-0">
                <span class="text-red-800">Five</span>
                <span class="text-yellow-500">Elements</span>
                <span class="text-red-800">International</span>
                <span class="text-yellow-500">School</span>
                <span class="text-red-800">Lost</span>
                <span class="text-yellow-500">&</span>
                <span class="text-yellow-500">Found</span>
            </h1>
            <div class="flex space-x-2">
                <button
                    onclick="openReportModal(true)"
                    class="px-4 py-2 bg-red-800 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-200"
                >
                    Report Lost
                </button>
                <button
                    onclick="openReportModal(false)"
                    class="px-4 py-2 bg-yellow-500 text-gray-900 font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition duration-200"
                >
                    Report Found
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-6">
        
        <div class="space-y-4 mb-6 p-4 bg-white rounded-xl shadow-lg">
            <div class="relative flex-grow">
                <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                <input
                    type="text"
                    id="search-term"
                    placeholder="Search by item, description, or location..."
                    oninput="handleFilterChange()"
                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"
                />
            </div>

            <div class="flex flex-wrap gap-3 items-center">
                <label class="text-sm font-medium text-gray-700">Filter:</label>
                <select id="filter-type" onchange="handleFilterChange()"
                    class="py-2 px-3 border border-gray-300 rounded-xl shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="all">All Types</option>
                    <option value="lost">Lost</option>
                    <option value="found">Found</option>
                </select>

                <select id="filter-category" onchange="handleFilterChange()"
                    class="py-2 px-3 border border-gray-300 rounded-xl shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="All Categories">All Categories</option>
                    </select>
                
                <select id="filter-grade" onchange="handleFilterChange()"
                    class="py-2 px-3 border border-gray-300 rounded-xl shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="All Grades">All Grades</option>
                    </select>
                
            </div>
        </div>
        
        <div id="loading-state" class="hidden p-8 text-center bg-white rounded-xl shadow-lg mt-8">
            <div class="spinner mx-auto"></div>
            <p class="text-xl text-gray-500 font-medium mt-4">Loading Reports...</p>
        </div>

        <div id="report-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 min-h-[300px]">
            </div>

        <div id="no-reports-message" class="hidden p-8 text-center bg-white rounded-xl shadow-lg mt-8">
            <p class="text-xl text-gray-500 font-medium">No reports found matching your criteria.</p>
        </div>

    </main>

    <div id="report-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg m-4 overflow-y-auto max-h-[90vh]">
            <div id="modal-header" class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 id="modal-title" class="text-2xl font-bold"></h2>
                <button onclick="closeReportModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="report-form" class="space-y-4">
                
                <div id="auto-title-display" class="p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-sm text-indigo-700 font-medium">
                    Report Title: <span id="generated-item-name" class="font-semibold"></span> (Auto-generated from Category)
                </div>

                <div class="border border-dashed border-gray-400 rounded-xl p-4 text-center space-y-3">
                    <label for="report-image-input" class="block text-sm font-medium text-gray-700 cursor-pointer">
                        <span class="inline-flex items-center text-indigo-600">
                            <i data-lucide="image" class="w-4 h-4 mr-2"></i>
                            Optional: Upload Item Photo
                        </span>
                    </label>
                    <input
                        type="file"
                        id="report-image-input"
                        accept="image/*"
                        onchange="handleImageUpload(event)"
                        class="hidden"
                    >
                    <div id="image-preview-container" class="mt-2 hidden">
                        <img id="image-preview" src="" alt="Image Preview" class="max-h-32 w-auto mx-auto rounded-lg object-contain shadow-md border border-gray-200">
                        <p id="image-filename" class="text-xs text-gray-500 mt-1 truncate"></p>
                    </div>
                    <button type="button" onclick="document.getElementById('report-image-input').click()" class="text-sm font-medium text-indigo-600 hover:text-indigo-800">
                        Click to Select Image
                    </button>
                </div>


                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="report-category" class="block text-sm font-medium text-gray-700">Item Category</label>
                        <select
                            id="report-category"
                            onchange="updateGeneratedTitle()"
                            required
                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border"
                        >
                            </select>
                    </div>
                    <div>
                        <label for="report-grade" class="block text-sm font-medium text-gray-700">Grade Level</label>
                        <select
                            id="report-grade"
                            required
                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border"
                        >
                            </select>
                    </div>
                    <div>
                        <label for="report-section" class="block text-sm font-medium text-gray-700">Section/Class</label>
                        <select
                            id="report-section"
                            required
                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border"
                        >
                            </select>
                    </div>
                </div>
                
                <div>
                    <label for="report-description" class="block text-sm font-medium text-gray-700">Unique Description</label>
                    <textarea
                        id="report-description"
                        placeholder="e.g., Has a key-chain of a dog, small tear on the top right pocket, etc. (crucial for identification!)"
                        rows="3"
                        required
                        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border"
                    ></textarea>
                </div>
                
                <div>
                    <label for="report-location" class="block text-sm font-medium text-gray-700">Location (Lost or Found)</label>
                    <input
                        id="report-location"
                        type="text"
                        placeholder="e.g., Cafeteria, Hallway near Room 101, Gym locker room"
                        required
                        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border"
                    />
                </div>
                
                <button
                    type="submit"
                    id="submit-button"
                    class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-sm font-medium transition duration-200"
                >
                    <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                    Submit Report
                </button>
            </form>
        </div>
    </div>

    <script>
        // --- Configuration ---
        
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // !!! PASTE YOUR DEPLOYED GOOGLE APPS SCRIPT URL HERE
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyQcEJBC5-ClHZ5o29fxTF9Y_w9QUTlgGtLKtTOSNMYGJ1K2wOCXua7qRwPlAilAMQj/exec";


        const ITEM_CATEGORIES = [
            'Backpack', 'Lunchbox', 'Textbook', 'Clothing', 'Electronics',
            'Water Bottle', 'Keys', 'Documents/IDs', 'Sports Gear', 'Other'
        ];

        const GRADE_LEVELS = [
            'Kindergarten', '1st Grade', '2nd Grade', '3rd Grade',
            '4th Grade', '5th Grade', '6th Grade', '7th Grade', '8th Grade',
            '9th Grade', 'Staff'
        ];

        const SECTION_LETTERS = [
            'A', 'B', 'C', 'D', 'E', 'F', 'General/None'
        ];

        // This will be populated from the Google Sheet
        let REPORTS_DATABASE = [];
        let isReportingLost = true; // State for the modal
        let nextReportId = 1; // Used for unique IDs, will be managed by Google Sheet
        const SIMULATED_USER_ID = "school-web-user";
        
        // TEMPORARY storage for the Base64 string during the form submission process
        let tempBase64Image = null;


        // --- Core Functions ---

        /**
         * Converts the selected file into a Base64 string for display/storage.
         */
        function handleImageUpload(event) {
            const file = event.target.files[0];
            const previewContainer = document.getElementById('image-preview-container');
            const previewImage = document.getElementById('image-preview');
            const filenameText = document.getElementById('image-filename');
            
            tempBase64Image = null; // Reset temp state
            previewContainer.classList.add('hidden'); // Hide until image loads

            if (file) {
                // Check file size (e.g., limit to 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert("Image is too large! Please select an image smaller than 2MB.");
                    event.target.value = ''; // Clear the input
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempBase64Image = e.target.result; // Store Base64 string
                    previewImage.src = tempBase64Image;
                    filenameText.textContent = file.name;
                    previewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file); // Converts file to Base64
            }
        }


        /**
         * Populates the category and grade dropdowns based on the constants.
         */
        function populateDropdowns() {
            const categorySelect = document.getElementById('filter-category');
            const reportCategorySelect = document.getElementById('report-category');
            
            const gradeSelect = document.getElementById('filter-grade');
            const reportGradeSelect = document.getElementById('report-grade');
            
            const reportSectionSelect = document.getElementById('report-section');

            // Populate Category dropdowns
            ITEM_CATEGORIES.forEach(cat => {
                const optionFilter = new Option(cat, cat);
                const optionReport = new Option(cat, cat);
                categorySelect.add(optionFilter);
                reportCategorySelect.add(optionReport);
            });
            
            // Populate Grade dropdowns
            GRADE_LEVELS.forEach(grade => {
                const optionFilter = new Option(grade, grade);
                const optionReport = new Option(grade, grade);
                gradeSelect.add(optionFilter);
                reportGradeSelect.add(optionReport);
            });

            // Populate Section dropdown
            SECTION_LETTERS.forEach(section => {
                reportSectionSelect.add(new Option(section, section));
            });
        }
        
        /**
         * [NEW] Fetches all reports from the Google Sheet API.
         */
        async function loadReports() {
            const loading = document.getElementById('loading-state');
            const noReportsMessage = document.getElementById('no-reports-message');
            
            loading.classList.remove('hidden');
            noReportsMessage.classList.add('hidden');
            REPORTS_DATABASE = []; // Clear old data

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Sort to show newest first (assuming 'id' is a number)
                REPORTS_DATABASE = data.sort((a, b) => b.id - a.id);
                console.log("Reports loaded from Google Sheet:", REPORTS_DATABASE);

            } catch (error) {
                console.error("Failed to load reports:", error);
                alert("Error: Could not load reports from the database. Please check the console.");
            } finally {
                loading.classList.add('hidden');
            }
        }
        
        /**
         * Filters the list of reports based on criteria.
         */
        function filterReports(reports) {
            const filterType = document.getElementById('filter-type').value;
            const filterCategory = document.getElementById('filter-category').value;
            const filterGrade = document.getElementById('filter-grade').value;
            const searchTerm = document.getElementById('search-term').value.toLowerCase();
            
            return reports.filter(report => {
                const typeMatch = filterType === 'all' || report.type === filterType;
                const categoryMatch = filterCategory === 'All Categories' || report.category === filterCategory;
                const gradeMatch = filterGrade === 'All Grades' || report.grade === filterGrade;

                // Handle potential null/undefined values from sheet
                const item = report.item || '';
                const description = report.description || '';
                const location = report.location || '';

                const searchMatch = searchTerm === '' ||
                    item.toLowerCase().includes(searchTerm) ||
                    description.toLowerCase().includes(searchTerm) ||
                    location.toLowerCase().includes(searchTerm);

                return typeMatch && categoryMatch && gradeMatch && searchMatch;
            });
        }

        /**
         * Renders the filtered reports to the DOM.
         */
        function renderReports() {
            const container = document.getElementById('report-list');
            const noReportsMessage = document.getElementById('no-reports-message');
            const loading = document.getElementById('loading-state');

            // Ensure loading is hidden
            loading.classList.add('hidden');

            const filteredReports = filterReports(REPORTS_DATABASE);

            container.innerHTML = '';

            if (filteredReports.length === 0) {
                noReportsMessage.classList.remove('hidden');
                return;
            }

            noReportsMessage.classList.add('hidden');
            
            filteredReports.forEach(report => {
                const isLost = report.type === 'lost';
                
                const typeColor = isLost
                    ? 'bg-red-100 text-red-800 border-red-800' // Maroon
                    : 'bg-yellow-500 text-gray-900 border-yellow-600'; // Yellow
                
                const cardBorder = isLost
                    ? 'border-l-4 border-red-800' // Maroon border
                    : 'border-l-4 border-yellow-500'; // Yellow border
                
                const typeIcon = isLost ? 'x' : 'search';
                // Check if base64_image string is present and not empty
                const hasImage = !!report.base64_image;
                const mediaIcon = hasImage ? 'camera' : 'file-text';
                
                const cardHtml = `
                    <div class="p-4 bg-white rounded-xl shadow-lg transition duration-300 hover:shadow-xl ${cardBorder}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="text-xl font-bold text-gray-800 capitalize">
                                ${report.item}
                            </div>
                            <span class="inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold ${typeColor} border">
                                <i data-lucide="${typeIcon}" class="w-4 h-4"></i> ${report.type}
                            </span>
                        </div>

                        ${hasImage ? `
                            <div class="mb-3 p-2 bg-gray-50 rounded-lg text-center border">
                                <img src="${report.base64_image}" alt="Item Photo" class="max-h-24 w-auto mx-auto rounded object-contain" onerror="this.onerror=null; this.src='https://placehold.co/100x100/eeeeee/333333?text=Image+Error';" />
                            </div>
                        ` : `
                            <div class="mb-3 p-2 bg-indigo-50 rounded-lg flex items-center text-sm text-indigo-700">
                                <i data-lucide="${mediaIcon}" class="w-4 h-4 mr-2 flex-shrink-0"></i>
                                No Media Attached
                            </div>
                        `}

                        <div class="grid grid-cols-2 gap-2 text-xs text-gray-600 mb-3 border-b pb-2">
                            <div class="flex items-center truncate">
                                <i data-lucide="tag" class="w-3 h-3 mr-1 text-indigo-400"></i>
                                <span class="font-semibold">Category:</span> ${report.category}
                            </div>
                            <div class="flex items-center truncate">
                                <i data-lucide="users" class="w-3 h-3 mr-1 text-indigo-400"></i>
                                <span class="font-semibold">Grade:</span> ${report.grade}
                            </div>
                            <div class="flex items-center truncate">
                                <i data-lucide="hash" class="w-3 h-3 mr-1 text-indigo-400"></i>
                                <span class="font-semibold">Section:</span> ${report.section}
                            </div>
                        </div>

                        <p class="text-sm text-gray-600 mb-3 line-clamp-2">${report.description}</p>

                        <div class="space-y-1 text-xs text-gray-500">
                            <div class="flex items-center">
                                <i data-lucide="map-pin" class="w-4 h-4 mr-2 text-indigo-400"></i>
                                <span class="font-medium">Location:</span> ${report.location}
                            </div>
                            <div class="flex items-center">
                                <i data-lucide="calendar" class="w-4 h-4 mr-2 text-indigo-400"></i>
                                <span class="font-medium">Date:</span> ${report.date}
                            </div>
                            <div class="flex items-center pt-1 mt-2 border-t border-gray-100">
                                <i data-lucide="shield" class="w-4 h-4 mr-2 text-gray-400"></i>
                                <span class="font-mono text-xs truncate">Reported By: ${report.user_id}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHtml);
            });
            // Re-render Lucide icons after adding new HTML
            lucide.createIcons();
        }

        // --- UI Logic ---
        
        function openReportModal(isLost) {
            isReportingLost = isLost;
            const modal = document.getElementById('report-modal');
            const titleElement = document.getElementById('modal-title');
            const submitButton = document.getElementById('submit-button');
            
            // Reset image fields when opening
            tempBase64Image = null;
            document.getElementById('report-image-input').value = '';
            document.getElementById('image-preview-container').classList.add('hidden');

            const headerText = isLost ? 'Report a Lost Item' : 'Report an Item Found';
            titleElement.textContent = headerText;
            titleElement.className = `text-2xl font-bold ${isLost ? 'text-red-800' : 'text-yellow-500'}`;
            
            // Reset submit button text and state
            submitButton.disabled = false;
            submitButton.innerHTML = `<i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Submit ${isLost ? 'Lost' : 'Found'} Report`;

            submitButton.className = `w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-sm font-medium transition duration-200 ${isLost
                ? 'bg-red-800 hover:bg-red-700 text-white'
                : 'bg-yellow-500 hover:bg-yellow-600 text-gray-900'}`;

            document.getElementById('report-form').reset();
            updateGeneratedTitle();
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons(); // Re-render icons inside modal
        }

        function closeReportModal() {
            tempBase64Image = null;
            document.getElementById('report-modal').classList.add('hidden');
            document.getElementById('report-modal').classList.remove('flex');
        }

        function updateGeneratedTitle() {
            const category = document.getElementById('report-category').value;
            const typeLabel = isReportingLost ? 'Lost Report' : 'Found Report';
            document.getElementById('generated-item-name').textContent = `${category} - ${typeLabel}`;
        }

        function handleFilterChange() {
            renderReports();
        }


        // --- Event Listeners and Initial Setup ---
        
        // [MODIFIED] window.onload to be async
        window.onload = async function() {
            // Render icons on initial page load
            lucide.createIcons();
            
            // Populate dropdowns first
            populateDropdowns();
            
            // Then, load data from the network and render it
            await loadReports();
            renderReports();
            
            // [MODIFIED] Attach async submit handler
            document.getElementById('report-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitButton = document.getElementById('submit-button');
                submitButton.disabled = true;
                submitButton.innerHTML = `<div class="spinner-small" style="width: 20px; height: 20px; border-left-color: white; border-width: 2px;"></div> <span class="ml-2">Submitting...</span>`;
                
                // 1. Gather all data
                const reportType = isReportingLost ? 'lost' : 'found';
                const category = document.getElementById('report-category').value;
                
                const newReport = {
                    id: new Date().getTime(), // Create a unique ID based on timestamp
                    type: reportType,
                    item: `${category} - ${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report`,
                    category: category,
                    grade: document.getElementById('report-grade').value,
                    section: document.getElementById('report-section').value,
                    description: document.getElementById('report-description').value.trim(),
                    location: document.getElementById('report-location').value.trim(),
                    date: new Date().toLocaleDateString(),
                    user_id: SIMULATED_USER_ID,
                    base64_image: tempBase64Image // Get the Base64 image
                };

                try {
                    // 2. Send data to Google Sheet
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors', // Required for cross-domain requests
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(newReport),
                    });

                    const result = await response.json();
                    if (result.status !== 'success') {
                        throw new Error(result.message || "Failed to post data.");
                    }
                    
                    console.log("Report submitted successfully:", result.data);

                    // 3. Reset state and refresh list
                    tempBase64Image = null;
                    closeReportModal();
                    
                    // 4. Reload all reports from the server to show the new one
                    await loadReports();
                    renderReports();

                } catch (error) {
                    console.error("Failed to submit report:", error);
                    alert("Error: Could not submit report. Please try again.");
                    // Re-enable button on failure
                    submitButton.disabled = false;
                    submitButton.innerHTML = `<i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Submit Report`;
                    lucide.createIcons();
                }
            });
        };

    </script>
</body>
</html>
